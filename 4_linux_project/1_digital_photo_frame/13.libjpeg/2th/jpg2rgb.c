/***************************************************************************************
Similarly, the rough outline of a JPEG decompression operation is:

Allocate and initialize a JPEG decompression object    // 分配和初始化一个decompression结构体
Specify the source of the compressed data (eg, a file) // 指定源文件
Call jpeg_read_header() to obtain image info		      // 用jpeg_read_header获得jpg图像信息
Set parameters for decompression		               // 设置解压参数,比如放大、缩小
jpeg_start_decompress(...); 			               // 启动解压：jpeg_start_decompress
while (scan lines remain to be read)
	jpeg_read_scanlines(...);		                   // 循环调用jpeg_read_scanlines
jpeg_finish_decompress(...);			               // jpeg_finish_decompress结束解压
Release the JPEG decompression object                  // 释放decompression结构体
***************************************************************************************/
#include <stdio.h>
#include "jpeglib.h"
#include <setjmp.h>

/* Uage : jpg2rgb <jpg_file>
 */
int main(int argc, char *argv[])
{
	struct jpeg_decompress_struct cinfo;
	struct jpeg_error_mgr jerr;
	FILE *infile;
	
	//分配和初始化一个decompression结构体
	cinfo.err = jpeg_std_error(&jerr);
	jpeg_create_decompress(&cinfo);

	//指定.jpg源文件
	if ((infile = fopen(argv[1], "rb")) == NULL) {
		fprintf(stderr, "can't open %s\n", argv[1]);	    
		return -1;	
	}	
	jpeg_stdio_src(&cinfo, infile);

	// 用jpeg_read_header获得jpg文件信息头
	jpeg_read_header(&cinfo, TRUE);
	
	//jpg源文件信息
	printf("image_width = %d\n", cinfo.image_width);
	printf("image_height = %d\n", cinfo.image_height);
	printf("num_components = %d\n", cinfo.num_components);
	
	// 设置解压参数,比如放大、缩小
	printf("enter M/N:\n");
	scanf("%d/%d", &cinfo.scale_num,  &cinfo.scale_denom);
	printf("scale to : %d/%d\n", cinfo.scale_num, cinfo.scale_denom);
	//cinfo.scale_num    = 1;
	//cinfo.scale_denom  = 2;////比例为1/2
	
	// 启动解压：jpeg_start_decompress	
	jpeg_start_decompress(&cinfo);

	//输出的图像文件信息
	printf("output_width = %d\n", cinfo.output_width);
	printf("output_height = %d\n", cinfo.output_height);
	printf("output_components = %d\n", cinfo.output_components);

	// 循环调用jpeg_read_scanlines来一行一行地获得解压的数据

	jpeg_finish_decompress(&cinfo);//结束解压
	jpeg_destroy_decompress(&cinfo);//释放解压使用结构体	
}

